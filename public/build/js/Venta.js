document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("codigoProducto"),e=document.getElementById("tablaProductos").querySelector("tbody"),n=document.getElementById("subtotalVenta"),o=document.getElementById("ivaVenta"),d=document.getElementById("totalVenta"),a=document.getElementById("entregaDomicilio"),c=document.getElementById("bloqueEntregaAdicional"),r=document.getElementById("direccion"),i=document.getElementById("fechaEntrega"),l=document.getElementById("horaEntrega"),u=document.getElementById("formVenta");let m=[];function s(){e.innerHTML="";let t=0;m.forEach(((n,o)=>{const d=n.precio*n.cantidad;t+=d;const a=document.createElement("tr");a.innerHTML=`\n                <td>\n                    ${n.codigo}\n                    <input type="hidden" name="productos[${o}][id]" value="${n.id}">\n                    <input type="hidden" name="productos[${o}][codigo]" value="${n.codigo}">\n                </td>\n                <td>\n                    <img src="/img/productos/${n.foto}" width="40" height="40" class="rounded-circle" alt="Producto">\n                </td>\n                <td>\n                    ${n.nombre}\n                    <input type="hidden" name="productos[${o}][nombre]" value="${n.nombre}">\n                </td>\n                <td>\n                    C$ ${n.precio.toFixed(2)}\n                    <input type="hidden" name="productos[${o}][precio]" value="${n.precio}">\n                </td>\n                <td>\n                    <input type="number" name="productos[${o}][cantidad]" min="1" value="${n.cantidad}" class="form-control form-control-sm cantidad" data-index="${o}">\n                </td>\n                <td>C$ ${d.toFixed(2)}</td>\n                <td>\n                    <button type="button" class="btn btn-danger btn-sm eliminar" data-index="${o}">X</button>\n                </td>\n            `,e.appendChild(a)}));const a=.15*t,c=t+a;n.textContent=t.toFixed(2),o.textContent=a.toFixed(2),d.textContent=c.toFixed(2),document.querySelectorAll(".cantidad").forEach((t=>{t.addEventListener("change",(t=>{const e=t.target.dataset.index,n=parseInt(t.target.value);n>0&&(m[e].cantidad=n,s())}))})),document.querySelectorAll(".eliminar").forEach((t=>{t.addEventListener("click",(t=>{const e=t.target.dataset.index;m.splice(e,1),s()}))}))}t.addEventListener("keydown",(async e=>{if("Enter"===e.key){e.preventDefault();const n=t.value.trim();""!==n&&(await async function(t){try{const e=await fetch(`/api/producto?codigo=${encodeURIComponent(t)}`),n=await e.json();if(!e.ok||!n||!n.idproducto)return void alert("Producto no encontrado");const o=m.find((t=>t.codigo===n.codigo_producto));o?o.cantidad++:m.push({id:n.idproducto,codigo:n.codigo_producto,nombre:n.nombre_producto,precio:parseFloat(n.precio),cantidad:1,foto:n.Foto||"default.png"}),s()}catch(t){console.error("Error al consultar producto:",t),alert("Error al consultar el producto")}}(n),t.value="")}})),a.addEventListener("change",(()=>{c.style.display=a.checked?"block":"none"})),u.addEventListener("submit",(t=>{0===m.length&&(t.preventDefault(),alert("Debes agregar al menos un producto.")),a.checked&&(r.value&&i.value&&l.value||(t.preventDefault(),alert("Completa todos los campos de entrega.")))}))}));