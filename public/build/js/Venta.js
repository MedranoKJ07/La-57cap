document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("codigoProducto"),e=document.getElementById("tablaProductos").querySelector("tbody"),o=document.getElementById("subtotalVenta"),n=document.getElementById("ivaVenta"),d=document.getElementById("totalVenta"),c=document.getElementById("entregaDomicilio"),a=document.getElementById("formularioEntrega");let r=[];function i(){e.innerHTML="";let t=0;r.forEach(((o,n)=>{const d=o.precio*o.cantidad;t+=d;const c=document.createElement("tr");c.innerHTML=`\n                <td>${o.codigo}</td>\n                <td><img src="/img/productos/${o.Foto}" width="40" height="40"\n                                         class="rounded-circle" alt="Imagen producto"></td>\n                <td>${o.nombre}</td>\n                <td>C$ ${o.precio.toFixed(2)}</td>\n                <td>\n                    <input type="number" min="1" value="${o.cantidad}" class="form-control form-control-sm cantidad" data-index="${n}">\n                </td>\n                <td>C$ ${d.toFixed(2)}</td>\n                <td><button class="btn btn-danger btn-sm eliminar" data-index="${n}">X</button></td>\n            `,e.appendChild(c)}));const c=.15*t,a=t+c;o.textContent=t.toFixed(2),n.textContent=c.toFixed(2),d.textContent=a.toFixed(2),document.querySelectorAll(".cantidad").forEach((t=>{t.addEventListener("change",(t=>{const e=t.target.dataset.index,o=parseInt(t.target.value);o>0&&(r[e].cantidad=o,i())}))})),document.querySelectorAll(".eliminar").forEach((t=>{t.addEventListener("click",(t=>{const e=t.target.dataset.index;r.splice(e,1),i()}))}))}t.addEventListener("keydown",(async e=>{if("Enter"===e.key){e.preventDefault();const o=t.value.trim();""!==o&&(await async function(t){try{const e=await fetch(`/api/producto?codigo=${encodeURIComponent(t)}`),o=await e.json();if(!e.ok||!o||!o.idproducto)return void alert("Producto no encontrado");const n=r.find((t=>t.codigo===o.codigo_producto));n?n.cantidad++:r.push({id:o.idproducto,codigo:o.codigo_producto,nombre:o.nombre_producto,precio:parseFloat(o.precio),cantidad:1,Foto:o.Foto||"default.png"}),i()}catch(t){console.error(t),alert("Error al consultar el producto")}}(o),t.value="")}})),c.addEventListener("change",(()=>{a.style.display=c.checked?"block":"none"}))}));