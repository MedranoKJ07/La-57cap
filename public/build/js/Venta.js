document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("codigoProducto"),t=(document.getElementById("idCliente"),document.getElementById("tablaProductos").querySelector("tbody")),n=document.getElementById("subtotalVenta"),o=document.getElementById("ivaVenta"),d=document.getElementById("totalVenta"),a=document.getElementById("entregaDomicilio"),c=(document.getElementById("clientenoTieneRegistro"),document.getElementById("bloqueEntregaAdicional")),r=document.getElementById("direccion"),i=document.getElementById("fechaEntrega"),l=document.getElementById("horaEntrega"),u=document.getElementById("formVenta");let m=[];function s(){t.innerHTML="";let e=0;m.forEach(((n,o)=>{const d=n.precio*n.cantidad;e+=d;const a=document.createElement("tr");a.innerHTML=`\n                <td>\n                    ${n.codigo}\n                    <input type="hidden" name="productos[${o}][id]" value="${n.id}">\n                    <input type="hidden" name="productos[${o}][codigo]" value="${n.codigo}">\n                </td>\n                <td>\n                    <img src="/img/productos/${n.foto}" width="40" height="40" class="rounded-circle" alt="Producto">\n                </td>\n                <td>\n                    ${n.nombre}\n                    <input type="hidden" name="productos[${o}][nombre]" value="${n.nombre}">\n                </td>\n                <td>\n                    C$ ${n.precio.toFixed(2)}\n                    <input type="hidden" name="productos[${o}][precio]" value="${n.precio}">\n                </td>\n                <td>\n                    <input type="number" name="productos[${o}][cantidad]" min="1" value="${n.cantidad}" class="form-control form-control-sm cantidad" data-index="${o}">\n                </td>\n                <td>C$ ${d.toFixed(2)}</td>\n                <td>\n                    <button type="button" class="btn btn-danger btn-sm eliminar" data-index="${o}">X</button>\n                </td>\n            `,t.appendChild(a)}));const a=.15*e,c=e+a;n.textContent=e.toFixed(2),o.textContent=a.toFixed(2),d.textContent=c.toFixed(2),document.querySelectorAll(".cantidad").forEach((e=>{e.addEventListener("change",(e=>{const t=e.target.dataset.index,n=parseInt(e.target.value);n>0&&(m[t].cantidad=n,s())}))})),document.querySelectorAll(".eliminar").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.dataset.index;m.splice(t,1),s()}))}))}e.addEventListener("keydown",(async t=>{if("Enter"===t.key){t.preventDefault();const n=e.value.trim();""!==n&&(await async function(e){try{const t=await fetch(`/api/producto?codigo=${encodeURIComponent(e)}`),n=await t.json();if(!t.ok||!n||!n.idproducto)return void alert("Producto no encontrado");const o=m.find((e=>e.codigo===n.codigo_producto));o?o.cantidad++:m.push({id:n.idproducto,codigo:n.codigo_producto,nombre:n.nombre_producto,precio:parseFloat(n.precio),cantidad:1,foto:n.Foto||"default.png"}),s()}catch(e){console.error("Error al consultar producto:",e),alert("Error al consultar el producto")}}(n),e.value="")}})),a.addEventListener("change",(()=>{c.style.display=a.checked?"block":"none"})),u.addEventListener("submit",(e=>{0===m.length&&(e.preventDefault(),alert("Debes agregar al menos un producto.")),a.checked&&(r.value&&i.value&&l.value||(e.preventDefault(),alert("Completa todos los campos de entrega.")))}))}));