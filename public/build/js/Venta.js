document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("codigoProducto"),t=document.getElementById("tablaProductos").querySelector("tbody"),n=document.getElementById("subtotalVenta"),o=document.getElementById("ivaVenta"),d=document.getElementById("totalVenta"),c=document.getElementById("entregaDomicilio"),a=document.getElementById("bloqueEntregaAdicional"),i=document.getElementById("direccion"),r=document.getElementById("fechaEntrega"),l=document.getElementById("horaEntrega"),u=document.getElementById("formVenta");let s=[];function m(){t.innerHTML="";let e=0;s.forEach((n,o)=>{const d=n.precio*n.cantidad;e+=d;const c=document.createElement("tr");c.innerHTML=`\n    <td>\n        ${n.codigo}\n        <input type="hidden" name="productos[${o}][id]" value="${n.id}">\n        <input type="hidden" name="productos[${o}][codigo]" value="${n.codigo}">\n    </td>\n    <td>\n        <img src="/img/productos/${n.foto}" width="40" height="40" class="rounded-circle" alt="Producto">\n    </td>\n    <td>\n        ${n.nombre}\n        <input type="hidden" name="productos[${o}][nombre]" value="${n.nombre}">\n    </td>\n    <td>\n        C$ ${n.precio.toFixed(2)}\n        <input type="hidden" name="productos[${o}][precio]" value="${n.precio}">\n    </td>\n    <td>\n        <input type="number"\n               name="productos[${o}][cantidad]"\n               min="1"\n               max="${n.stock_disponible}"\n               value="${n.cantidad}"\n               class="form-control form-control-sm cantidad"\n               data-index="${o}">\n    </td>\n    <td>C$ ${d.toFixed(2)}</td>\n    <td>\n        <button type="button" class="btn btn-danger btn-sm eliminar" data-index="${o}">X</button>\n    </td>\n`,t.appendChild(c)});const c=.15*e,a=e+c;n.textContent=e.toFixed(2),o.textContent=c.toFixed(2),d.textContent=a.toFixed(2),document.querySelectorAll(".cantidad").forEach(e=>{e.addEventListener("change",e=>{const t=e.target.dataset.index,n=parseInt(e.target.value);n>0&&(s[t].cantidad=n,m())})}),document.querySelectorAll(".eliminar").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.index;s.splice(t,1),m()})})}e.addEventListener("keydown",async t=>{if("Enter"===t.key){t.preventDefault();const n=e.value.trim();""!==n&&(await async function(e){try{const t=await fetch(`/api/producto?codigo=${encodeURIComponent(e)}`),n=await t.json();if(!t.ok||!n||!n.idproducto)return void alert("Producto no encontrado");if(!n.disponible_para_venta)return void alert("Este producto no está disponible para la venta. El stock mínimo se alcanzó.");const o=s.find(e=>e.codigo===n.codigo_producto);o?o.cantidad++:s.push({id:n.idproducto,codigo:n.codigo_producto,nombre:n.nombre_producto,precio:parseFloat(n.precio),cantidad:1,foto:n.Foto||"default.png",stock_disponible:n.stock_disponible}),m()}catch(e){console.error("Error al consultar producto:",e),alert("Error al consultar el producto")}}(n),e.value="")}}),c.addEventListener("change",()=>{a.style.display=c.checked?"block":"none"}),u.addEventListener("submit",e=>{0===s.length&&(e.preventDefault(),alert("Debes agregar al menos un producto.")),c.checked&&(i.value&&r.value&&l.value||(e.preventDefault(),alert("Completa todos los campos de entrega.")))});document.getElementById("clientenoTieneRegistro").checked&&(E.style.display="none");const p=document.getElementById("buscarClienteBtn"),g=document.getElementById("clientenoTieneRegistro"),y=document.getElementById("idCliente"),E=document.getElementById("buscar"),v=document.getElementById("datosCliente"),b=document.getElementById("id_cliente_registrado"),h=document.getElementById("nombre_cliente_mostrado"),f=document.getElementById("telefono_cliente_mostrado"),I=document.getElementById("direccion_cliente_mostrado");function B(){b.value="",h.value="",f.value="",I.value=""}g.addEventListener("change",function(){this.checked?(E.style.display="none",v.style.display="none",y.placeholder="Cliente genérico",y.disabled=!0,B()):(y.placeholder="Buscar por nombre del cliente",v.style.display="block",E.style.display="block")}),p.addEventListener("click",async()=>{if(g.checked)return void B();const e=y.value.trim();if(""===e)return;const t=await async function(e){try{const t=await fetch(`/api/cliente?nombre=${encodeURIComponent(e)}`),n=await t.json();return t.ok?n:null}catch(e){return console.error("Error al buscar cliente:",e),null}}(e);t?(b.value=t.idcliente,h.value=t.nombre_completo,f.value=t.telefono,I.value=t.direccion):(B(),alert("Cliente no encontrado."))})});